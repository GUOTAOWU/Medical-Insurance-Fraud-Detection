<!-- この画面は保険金請求データの総合的な管理を行うためのハブページであり、
新規レコードの作成やExcelファイルを用いたデータの一括インポート・エクスポート機能に加え、
請求番号（CL_NO）による検索機能を提供しています。画面下部には登録されているデータがリスト形式（または検索結果の詳細形式）で表示され、
各案件の進捗ステータスや支払金額などの重要情報を確認しながら、必要に応じて個別の編集や削除操作を直接実行することができます。 -->



{% extends "base.html" %}

{% block title %}数据管理{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">数据管理</h2>

  <!-- 操作按钮 -->
  <div class="d-flex gap-2 mb-4">
    <a href="{{ url_for('data_add') }}" class="btn btn-success">
      <i class="bi bi-plus-circle"></i> 新增记录
    </a>
    <form action="{{ url_for('data_import') }}"
          method="post"
          enctype="multipart/form-data"
          class="d-flex align-items-center gap-2 mb-0">
      <input type="file" name="file" accept=".xls,.xlsx"
             class="form-control form-control-sm" required>
      <button type="submit" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-upload"></i> 导入 Excel
      </button>
    </form>
    <a href="{{ url_for('data_export') }}" class="btn btn-outline-success btn-sm ms-auto">
      <i class="bi bi-download"></i> 导出 Excel
    </a>
  </div>

  <!-- 搜索表单 -->
  <form method="post" class="row g-3 mb-4">
    <div class="col-auto">
      <input name="cl_no" class="form-control" placeholder="输入 CL_NO 搜索">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">搜索</button>
    </div>
  </form>

  <!-- 数据展示 -->
  <div class="table-responsive">
    {% if record %}
      <!-- 单条记录展示 -->
      <table class="table table-bordered">
        <tr>
          <th>CL_NO</th>
          <td>{{ record.cl_no }}</td>
        </tr>
        <tr>
          <th>出险开始</th>
          <td>
            {% if record.incur_date_from %}
              {{ record.incur_date_from.strftime('%Y-%m-%d') }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>出险结束</th>
          <td>
            {% if record.incur_date_to %}
              {{ record.incur_date_to.strftime('%Y-%m-%d') }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>福利项目</th>
          <td>{{ record.ben_head or '—' }}</td>
        </tr>
        <tr>
          <th>疾病代码</th>
          <td>{{ record.diag_code or '—' }}</td>
        </tr>
        <tr>
          <th>条形码列表</th>
          <td>{{ record.codes or '—' }}</td>
        </tr>
        <tr>
          <th>机构名称</th>
          <td>{{ record.prov_name or '—' }}</td>
        </tr>
        <tr>
          <th>划账时间</th>
          <td>
            {% if record.pay_date %}
              {{ record.pay_date.strftime('%Y-%m-%d %H:%M:%S') }}
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>赔付金额</th>
          <td>{{ record.pay_amt or '—' }}</td>
        </tr>
        <!-- 新增：理赔状态 -->
        <tr>
          <th>理赔状态</th>
          <td>{{ record.cl_line_status or '—' }}</td>
        </tr>
      </table>

      <div class="mt-3">
        <a href="{{ url_for('data_edit', cid=record.id) }}" class="btn btn-warning">
          <i class="bi bi-pencil-square"></i> 编辑
        </a>
        <a href="{{ url_for('data_delete', cid=record.id) }}"
           class="btn btn-danger ms-2"
           onclick="return confirm('确定删除？');">
          <i class="bi bi-trash"></i> 删除
        </a>
        <a href="{{ url_for('data_management') }}" class="btn btn-secondary ms-2">
          返回列表
        </a>
      </div>

    {% else %}
      <!-- 列表展示 -->
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>CL_NO</th>
            <th>出险开始</th>
            <th>出险结束</th>
            <th>福利项目</th>
            <th>机构名称</th>
            <th>赔付金额</th>
            <th>理赔状态</th>    <!-- 新增表头 -->
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {% for r in records %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.cl_no }}</td>
            <td>
              {{ r.incur_date_from.strftime('%Y-%m-%d') if r.incur_date_from else '—' }}
            </td>
            <td>
              {{ r.incur_date_to.strftime('%Y-%m-%d') if r.incur_date_to else '—' }}
            </td>
            <td>{{ r.ben_head or '—' }}</td>
            <td>{{ r.prov_name or '—' }}</td>
            <td>{{ r.pay_amt or '—' }}</td>
            <td>{{ r.cl_line_status or '—' }}</td>  <!-- 新增列内容 -->
            <td>
              <a href="{{ url_for('data_edit', cid=r.id) }}" class="btn btn-sm btn-warning">
                <i class="bi bi-pencil-square"></i>
              </a>
              <a href="{{ url_for('data_delete', cid=r.id) }}"
                 class="btn btn-sm btn-danger ms-1"
                 onclick="return confirm('确定删除？');">
                <i class="bi bi-trash"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>
</div>
{% endblock %}
